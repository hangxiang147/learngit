package com.zhizaolian.staff.dao.impl;

import java.util.Collections;
import java.util.List;

import org.hibernate.Query;
import org.hibernate.Session;
import org.hibernate.SessionFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.CollectionUtils;

import com.zhizaolian.staff.dao.PermissionMembershipDao;
import com.zhizaolian.staff.entity.PermissionMembershipEntity;
import com.zhizaolian.staff.utils.Lists2;
import com.zhizaolian.staff.utils.SafeFunction;

public class PermissionMembershipDaoImpl implements PermissionMembershipDao{
	
	@Autowired
	private SessionFactory sessionFactory;

	@Override
	@SuppressWarnings("unchecked")
	public List<Integer> findPermissionIDsByUserGroupIDType(String userGroupID, int type) {
		Session session = sessionFactory.getCurrentSession();
		String sql = "select pm.PermissionID as permissionID from OA_PermissionMembership pm where pm.IsDeleted = 0 and pm.UserGroupID = :userGroupID and pm.Type = :type";
		Query query = session.createSQLQuery(sql);
		query.setParameter("userGroupID", userGroupID);
		query.setParameter("type", type);
		return query.list();
	}
	
	@Override
	@SuppressWarnings("unchecked")
	public List<Integer> findPermissionIDsByUserGroupIDsType(List<String> userGroupIDs, int type) {
		if (CollectionUtils.isEmpty(userGroupIDs)) {
			return Collections.emptyList();
		}
		
		Session session = sessionFactory.getCurrentSession();
		String sql = "select pm.PermissionID as permissionID from OA_PermissionMembership pm where pm.IsDeleted = 0 and pm.UserGroupID in (:userGroupIDs) and pm.Type = :type";
		Query query = session.createSQLQuery(sql);
		query.setParameterList("userGroupIDs", userGroupIDs);
		query.setParameter("type", type);
		return query.list();
	}
	
	@Override
	@SuppressWarnings("unchecked")
	public List<String> findUserGroupIDsByPermissionIDType(int permissionID, int type) {
		Session session = sessionFactory.getCurrentSession();
		String hql = "from PermissionMembershipEntity membership where membership.isDeleted = 0 and membership.permissionID = :permissionID and membership.type = :type";
		Query query = session.createQuery(hql);
		query.setParameter("permissionID", permissionID);
		query.setParameter("type", type);
		return Lists2.transform(query.list(), new SafeFunction<PermissionMembershipEntity, String>() {
			@Override
			protected String safeApply(PermissionMembershipEntity input) {
				return input.getUserGroupID();
			}
		});
	}
}
