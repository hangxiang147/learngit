package com.zhizaolian.staff.service.impl;

import java.math.BigInteger;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.activiti.engine.HistoryService;
import org.activiti.engine.IdentityService;
import org.activiti.engine.RuntimeService;
import org.activiti.engine.TaskService;
import org.activiti.engine.history.HistoricDetail;
import org.activiti.engine.history.HistoricVariableUpdate;
import org.activiti.engine.identity.Group;
import org.activiti.engine.runtime.ProcessInstance;
import org.activiti.engine.task.Task;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.util.CollectionUtils;

import com.zhizaolian.staff.dao.BaseDao;
import com.zhizaolian.staff.dao.ResignationDao;
import com.zhizaolian.staff.entity.ResignationEntity;
import com.zhizaolian.staff.enums.BusinessTypeEnum;
import com.zhizaolian.staff.enums.Constants;
import com.zhizaolian.staff.enums.IsDeletedEnum;
import com.zhizaolian.staff.enums.TaskDefKeyEnum;
import com.zhizaolian.staff.enums.TaskResultEnum;
import com.zhizaolian.staff.service.PermissionService;
import com.zhizaolian.staff.service.PositionService;
import com.zhizaolian.staff.service.ProcessService;
import com.zhizaolian.staff.service.ResignationService;
import com.zhizaolian.staff.service.StaffService;
import com.zhizaolian.staff.utils.DateUtil;
import com.zhizaolian.staff.utils.ListResult;
import com.zhizaolian.staff.utils.Lists2;
import com.zhizaolian.staff.utils.SafeFunction;
import com.zhizaolian.staff.vo.DepartmentVO;
import com.zhizaolian.staff.vo.GroupDetailVO;
import com.zhizaolian.staff.vo.ResignationVO;
import com.zhizaolian.staff.vo.StaffVO;
import com.zhizaolian.staff.vo.TaskVO;

public class ResignationServiceImpl implements ResignationService {
	
	@Autowired
	private ResignationDao resignationDao;
	@Autowired
	private BaseDao baseDao;
	@Autowired
	private StaffService staffService;
	@Autowired
	private RuntimeService runtimeService;
	@Autowired
	private TaskService taskService;
	@Autowired
	private HistoryService historyService;
	@Autowired
	private ProcessService processService;
	@Autowired
	private PermissionService permissionService;
	@Autowired
	private IdentityService identityService;
	@Autowired
	private PositionService positionService;

	@Override
	public void startResignation(ResignationVO resignationVO) {
		resignationVO.setBusinessType(BusinessTypeEnum.RESIGNATION.getName());
		resignationVO.setTitle(resignationVO.getRequestUserName()+"的"+BusinessTypeEnum.RESIGNATION.getName());
		// 初始化任务参数
		Map<String, Object> vars = new HashMap<String, Object>();
		vars.put("arg", resignationVO);
		String supervisor = staffService.querySupervisor(resignationVO.getRequestUserID());
		String manager = staffService.queryManager(resignationVO.getRequestUserID());
		
		List<Group> groups = identityService.createGroupQuery().groupMember(resignationVO.getRequestUserID()).list();
		int companyID = Integer.parseInt(groups.get(0).getType().split("_")[0]);
		List<String> resignationHRAuditUsers = permissionService.findUsersByPermissionCodeCompany(Constants.RESIGNATION_HR_AUDIT, companyID);
		List<String> resignationHRAuditGroups = permissionService.findGroupsByPermissionCodeCompany(Constants.RESIGNATION_HR_AUDIT, companyID);
		List<String> resignationTransferGroups = permissionService.findGroupsByPermissionCodeCompany(Constants.RESIGNATION_TRANSFER, companyID);
		List<String> salarySettlementGroups = permissionService.findGroupsByPermissionCode(Constants.SALARY_SETTLEMENT);
		if (StringUtils.isBlank(manager)) {
			throw new RuntimeException("未找到该申请的审批人！");
		}
		if ((!staffService.hasGroupMember(resignationHRAuditGroups) && CollectionUtils.isEmpty(resignationHRAuditUsers)) 
				||!staffService.hasGroupMember(resignationTransferGroups) 
				||!staffService.hasGroupMember(salarySettlementGroups)) {
			throw new RuntimeException("未找到该申请的审批人！");
		}
		
		vars.put("supervisor", supervisor);
		vars.put("manager", manager);
		vars.put("resignationHRAuditUsers", resignationHRAuditUsers);
		vars.put("resignationHRAuditGroups", resignationHRAuditGroups);
		vars.put("resignationTransferGroups", resignationTransferGroups);
		vars.put("salarySettlementGroups", salarySettlementGroups);
		
		ProcessInstance processInstance = runtimeService.startProcessInstanceByKey(Constants.RESIGNATION);
		// 查询任务
		Task task = taskService.createTaskQuery()
				.processInstanceId(processInstance.getId()).singleResult();
		// 设置任务受理人
		taskService.setAssignee(task.getId(), resignationVO.getUserID());
		// 完成任务
		taskService.complete(task.getId(), vars);
		// 记录离职数据
		saveResignation(resignationVO, processInstance.getId());
	}
	
	@Override
	public ListResult<ResignationVO> findResignationListByUserID(String userID, int page, int limit) {
		//查询OA_Resignation表的数据
		List<ResignationEntity> resignationEntities = resignationDao.findResignationsByUserID(userID, page, limit);
		List<ResignationVO> resignationVOs = new ArrayList<ResignationVO>();
		for (ResignationEntity resignation : resignationEntities) {
			ResignationVO resignationVO = new ResignationVO();
			resignationVO.setProcessInstanceID(resignation.getProcessInstanceID());
			resignationVO.setLeaveDate(resignation.getLeaveDate()==null?"":DateUtil.formateDate(resignation.getLeaveDate()));
			resignationVO.setReasons(resignation.getReasons());
			resignationVO.setNote(resignation.getNote());
			resignationVO.setSupervisorConfirmDate(resignation.getSupervisorConfirmDate()==null ? "" : DateUtil.formateDate(resignation.getSupervisorConfirmDate()));
			resignationVO.setManagerConfirmDate(resignation.getManagerConfirmDate()==null ? "" : DateUtil.formateDate(resignation.getManagerConfirmDate()));
			
			List<HistoricDetail> datas = historyService.createHistoricDetailQuery().processInstanceId(resignation.getProcessInstanceID()).list();
			for (HistoricDetail historicDetail : datas) {
				HistoricVariableUpdate variable = (HistoricVariableUpdate) historicDetail;
				if (variable.getVariableName().equals("arg")) {
					ResignationVO arg = (ResignationVO) variable.getValue();
					resignationVO.setRequestDate(arg.getRequestDate());
					resignationVO.setRequestUserName(arg.getRequestUserName());
					resignationVO.setTitle(arg.getTitle());
				}
			}
			//查询流程实例
			ProcessInstance pInstance = runtimeService.createProcessInstanceQuery()
					.processInstanceId(resignation.getProcessInstanceID()).singleResult();
			
			if (pInstance != null) {
				resignationVO.setStatus("处理中");
				resignationVO.setAssigneeUserName(processService.getProcessTaskAssignee(pInstance.getId()));
			} else {
				resignationVO.setStatus(TaskResultEnum.valueOf(resignation.getProcessStatus()).getName());
			}
			resignationVOs.add(resignationVO);
		}
		
		int count = resignationDao.countResignationsByUserID(userID);
		return new ListResult<ResignationVO>(resignationVOs, count);
	}
	
	@Override 
	public void updateProcessStatus(String processInstanceID, TaskResultEnum taskResult) {
		if (taskResult == null) {
			throw new RuntimeException("处理结果不合法！");
		}
		
		resignationDao.updateProcessStatusByProcessInstanceID(processInstanceID, taskResult.getValue());
	}
	
	@Override
	public ListResult<TaskVO> findResignationTasksByUserGroupIDs(List<TaskDefKeyEnum> tasks, List<Group> groups, List<String> users, int page, int limit) {
		String groupIDs = Arrays.toString(Lists2.transform(groups, new SafeFunction<Group, String>() {
			@Override
			protected String safeApply(Group input) {
				return "'"+input.getId()+"'";
			}
		}).toArray());
		String taskNames = Arrays.toString(Lists2.transform(tasks, new SafeFunction<TaskDefKeyEnum, String>() {
			@Override
			protected String safeApply(TaskDefKeyEnum input) {
				return "'"+input.getName()+"'";
			}
		}).toArray());
		String userIDs = Arrays.toString(Lists2.transform(users, new SafeFunction<String, String>() {
			@Override
			protected String safeApply(String input) {
				return "'"+input+"'";
			}
		}).toArray());
		String sql = "select DISTINCT task.ID_, task.PROC_INST_ID_, task.NAME_ from ACT_RU_TASK task, ACT_RU_IDENTITYLINK identityLink "
				+ "where task.ID_ = identityLink.TASK_ID_ and identityLink.TYPE_ = 'candidate' and "
				+ "task.TASK_DEF_KEY_ in ("+taskNames.substring(1, taskNames.length()-1)+") "
				+ "and (identityLink.GROUP_ID_ in ("+groupIDs.substring(1, groupIDs.length()-1)+") "
				+ "or identityLink.USER_ID_ in ("+userIDs.substring(1, userIDs.length()-1)+"))";
		List<Object> result = baseDao.findPageList(sql, page, limit);
		List<TaskVO> taskVOs = createTaskVOList(result);
		
		sql = "select count(DISTINCT task.ID_) from ACT_RU_TASK task, ACT_RU_IDENTITYLINK identityLink "
				+ "where task.ID_ = identityLink.TASK_ID_ and identityLink.TYPE_ = 'candidate' and "
				+ "task.TASK_DEF_KEY_ in ("+taskNames.substring(1, taskNames.length()-1)+") "
				+ "and (identityLink.GROUP_ID_ in ("+groupIDs.substring(1, groupIDs.length()-1)+") "
				+ "or identityLink.USER_ID_ in ("+userIDs.substring(1, userIDs.length()-1)+"))";
		Object countObj = baseDao.getUniqueResult(sql);
		int count = countObj==null ? 0 : ((BigInteger)countObj).intValue();
		return new ListResult<TaskVO>(taskVOs, count);
	}
	
	@Override
	public ListResult<TaskVO> findResignationTasksByGroups(List<Group> groups, List<TaskDefKeyEnum> tasks, int page, int limit) {
		String groupIDs = Arrays.toString(Lists2.transform(groups, new SafeFunction<Group, String>() {
			@Override
			protected String safeApply(Group input) {
				return "'"+input.getId()+"'";
			}
		}).toArray());
		String taskNames = Arrays.toString(Lists2.transform(tasks, new SafeFunction<TaskDefKeyEnum, String>() {
			@Override
			protected String safeApply(TaskDefKeyEnum input) {
				return "'"+input.getName()+"'";
			}
		}).toArray());
		String sql = "select DISTINCT task.ID_, task.PROC_INST_ID_, task.NAME_ from ACT_RU_TASK task, ACT_RU_IDENTITYLINK identityLink "
				+ "where task.ID_ = identityLink.TASK_ID_ and identityLink.TYPE_ = 'candidate' and "
				+ "task.TASK_DEF_KEY_ in ("+taskNames.substring(1, taskNames.length()-1)+") "
				+ "and identityLink.GROUP_ID_ in ("+groupIDs.substring(1, groupIDs.length()-1)+")";
		List<Object> result = baseDao.findPageList(sql, page, limit);
		List<TaskVO> taskVOs = createTaskVOList(result);
		
		sql = "select count(DISTINCT task.ID_) from ACT_RU_TASK task, ACT_RU_IDENTITYLINK identityLink "
				+ "where task.ID_ = identityLink.TASK_ID_ and identityLink.TYPE_ = 'candidate' and "
				+ "task.TASK_DEF_KEY_ in ("+taskNames.substring(1, taskNames.length()-1)+") "
				+ "and identityLink.GROUP_ID_ in ("+groupIDs.substring(1, groupIDs.length()-1)+")";
		Object countObj = baseDao.getUniqueResult(sql);
		int count = countObj==null ? 0 : ((BigInteger)countObj).intValue();
		return new ListResult<TaskVO>(taskVOs, count);
	}
	
	@Override
	public List<TaskVO> createTaskVOListByTaskList(List<Task> tasks) {
		List<TaskVO> taskVOs = new ArrayList<TaskVO>();
		for (Task task : tasks) {
			//查询流程实例
			ProcessInstance pInstance = runtimeService.createProcessInstanceQuery()
					.processInstanceId(task.getProcessInstanceId()).singleResult();
			//查询流程参数
			ResignationVO arg = (ResignationVO) runtimeService.getVariable(pInstance.getId(), "arg");
			TaskVO taskVO = new TaskVO();
			taskVO.setProcessInstanceID(task.getProcessInstanceId());
			taskVO.setRequestUserName(arg.getUserName());
			taskVO.setRequestDate(arg.getRequestDate());
			taskVO.setTaskID(task.getId());
			taskVO.setTitle(arg.getTitle());
			taskVO.setTaskName(task.getName());
			StaffVO staffVO = staffService.getStaffByUserID(arg.getRequestUserID());
			if (staffVO != null) {
				List<GroupDetailVO> groups = staffService.findGroupDetailsByUserID(staffVO.getUserID());
				taskVO.setGroupList(Lists2.transform(groups, new SafeFunction<GroupDetailVO, String>() {
					@Override
					protected String safeApply(GroupDetailVO input) {
						return input.getCompanyName()+"—"+input.getDepartmentName()+"—"+input.getPositionName();
					}
				}));
			}
			taskVOs.add(taskVO);
		}
		return taskVOs;
	}
	
	@Override
	public void confirmLeaveDate(String processInstanceID, Date leaveDate, String taskDefKey) {
		ResignationVO resignationVO = (ResignationVO) runtimeService.getVariable(processInstanceID, "arg");
		if (TaskDefKeyEnum.SUPERVISOR_AUDIT.getName().equals(taskDefKey)) {
			//主管确认离职日期
			resignationVO.setSupervisorConfirmDate(DateUtil.formateDate(leaveDate));
			resignationDao.updateSupervisorConfirmDate(processInstanceID, leaveDate);
		} else if (TaskDefKeyEnum.MANAGER_AUDIT.getName().equals(taskDefKey)) {
			//总经理确认离职日期
			resignationVO.setManagerConfirmDate(DateUtil.formateDate(leaveDate));
			resignationDao.updateManagerConfirmDate(processInstanceID, leaveDate);
		}
		runtimeService.setVariable(processInstanceID, "arg", resignationVO);
	}
	
	@Override
	public ResignationVO getResignationVOByTaskID(String taskID) {
		ProcessInstance pInstance = processService.getProcessInstance(taskID);
		return (ResignationVO) runtimeService.getVariable(pInstance.getId(), "arg");
	}
	
	private List<TaskVO> createTaskVOList(List<Object> tasks) {
		List<TaskVO> taskVOs = new ArrayList<TaskVO>();
		for (Object task : tasks) {
			Object[] objs = (Object[]) task;
			//查询流程实例
			ProcessInstance pInstance = runtimeService.createProcessInstanceQuery()
					.processInstanceId((String)objs[1]).singleResult();
			//查询流程参数
			ResignationVO arg = (ResignationVO) runtimeService.getVariable(pInstance.getId(), "arg");
			TaskVO taskVO = new TaskVO();
			taskVO.setProcessInstanceID((String) objs[1]);
			taskVO.setRequestUserName(arg.getUserName());
			taskVO.setRequestDate(arg.getRequestDate());
			taskVO.setTaskID((String) objs[0]);
			taskVO.setTaskName((String) objs[2]);
			taskVO.setTitle(arg.getTitle());
			StaffVO staffVO=null;
			try{
				 staffVO = staffService.getStaffByUserID(arg.getRequestUserID());				
			}catch(Exception e){
				e.printStackTrace();
			}
			if (staffVO != null) {
				List<GroupDetailVO> groups = staffService.findGroupDetailsByUserID(staffVO.getUserID());
				taskVO.setGroupList(Lists2.transform(groups, new SafeFunction<GroupDetailVO, String>() {
					@Override
					protected String safeApply(GroupDetailVO input) {
						return input.getCompanyName()+"—"+input.getDepartmentName()+"—"+input.getPositionName();
					}
				}));
			}
			taskVOs.add(taskVO);
		}
		return taskVOs;
	}
	
	private void saveResignation(ResignationVO resignation, String processInstanceID) {
		Date now = new Date();
		ResignationEntity resignationEntity = ResignationEntity.builder()
													.userID(resignation.getUserID())
													.requestUserID(resignation.getRequestUserID())
													.leaveDate(DateUtil.getSimpleDate(resignation.getLeaveDate()))
													.reasons(StringUtils.join(resignation.getReason(), "；"))
													.note(resignation.getNote())
													.processInstanceID(processInstanceID)
													.isDeleted(IsDeletedEnum.NOT_DELETED.getValue())
													.addTime(now)
													.updateTime(now)
													.build();
		resignationDao.save(resignationEntity);
	}

	@Override
	public ListResult<ResignationVO> findResignationByResignationVO(ResignationVO resignationVO, int page, int limit) {
		List<Object> list=baseDao.findPageList(getResignationListBySql(resignationVO), page, limit);
		List<ResignationVO> resignationVOs = new ArrayList<>();
		for(Object obj:list){
			Object[] objs=(Object[])obj;
			ResignationVO resignationVO1=new ResignationVO();
			resignationVO1.setRequestUserName((String) objs[0]);
			resignationVO1.setLeaveDate(objs[2]==null?"":DateUtil.formateDate((Date) objs[2]));
			resignationVO1.setReasons((String) objs[3]);
			resignationVO1.setNote((String) objs[4]);
			resignationVO1.setRequestLeaveDate(objs[5]==null?"":DateUtil.formateDate((Date) objs[5]));
			resignationVO1.setManagerConfirmDate(objs[6]==null?"":DateUtil.formateDate((Date) objs[6]));
			resignationVO1.setRequestDate(objs[7]==null?"":DateUtil.formateFullDate((Date) objs[7]));
			resignationVO1.setTelephone((String) objs[8]);
			resignationVO1.setEntryDate(objs[9]==null?"":DateUtil.formateDate((Date) objs[9]));
			List<GroupDetailVO> groups = staffService.findGroupDetailsByUserID((String) objs[1]);
			if(resignationVO.getCompanyID()!=null){
				for(GroupDetailVO group:groups){
					if(group.getCompanyID()==resignationVO.getCompanyID()){
						resignationVO1.setDepartmentName(group.getDepartmentName());
				   }
				}
				
			}else{
				resignationVO1.setDepartmentName(CollectionUtils.isEmpty(groups)?"":groups.get(0).getDepartmentName());
			}

			resignationVOs.add(resignationVO1);
		}
		Object countObj=baseDao.getUniqueResult(getCountResignationBySql(resignationVO));
		int count=countObj == null? 0:((BigInteger)countObj).intValue();
		return new ListResult<ResignationVO>(resignationVOs,count);
	}
	
	private String getResignationListBySql(ResignationVO resignationVO){
		StringBuffer sql=new StringBuffer("select distinct * from(select  staff.StaffName,staff.UserID,staff.leaveDate,"
				+ "resignation.reasons, resignation.note, resignation.LeaveDate AS requestLeaveDate, "
				+ "resignation.managerConfirmDate, resignation.AddTime,staff.Telephone,staff.EntryDate,IFNULL(staff.leaveDate,resignation.managerConfirmDate) as _leaveDate from OA_Staff staff "
				+ "LEFT JOIN OA_Resignation resignation ON resignation.RequestUserID = staff.UserID "
				+ "LEFT JOIN ACT_ID_MEMBERSHIP membership ON staff.UserID = membership.USER_ID_ "
				+ "LEFT JOIN OA_GroupDetail groupDetail ON membership.GROUP_ID_ = groupDetail.GroupID "
				+ "where staff.IsDeleted = 0 AND ((staff.`Status` = 4) "
				+ "OR (resignation.IsDeleted = 0 AND resignation.ProcessStatus = 1 AND resignation.ManagerConfirmDate IS NOT NULL)) ");
		sql.append(getWhereBySql(resignationVO));
		sql.append(")a ORDER BY _leaveDate");
		
		return sql.toString();
	}
	
	private String getCountResignationBySql(ResignationVO resignationVO){
		StringBuffer sql=new StringBuffer("select count(*) from(select distinct * from(select  staff.StaffName,staff.UserID,staff.leaveDate,"
				+ "resignation.reasons,resignation.note from OA_Staff staff "
				+ "LEFT JOIN OA_Resignation resignation ON resignation.RequestUserID = staff.UserID "
				+ "LEFT JOIN ACT_ID_MEMBERSHIP membership ON staff.UserID = membership.USER_ID_ "
				+ "LEFT JOIN OA_GroupDetail groupDetail ON membership.GROUP_ID_ = groupDetail.GroupID "
				+ "where staff.IsDeleted = 0 AND ((staff.`Status` = 4 AND resignation.ResignationID IS NULL) "
				+ "OR (resignation.IsDeleted = 0 AND resignation.ProcessStatus = 1 AND resignation.ManagerConfirmDate IS NOT NULL)) ");
		sql.append(getWhereBySql(resignationVO));
		sql.append(")a)s");
		return sql.toString();
	}
	
	private String getWhereBySql(ResignationVO resignationVO){
		StringBuffer whereSql=new StringBuffer();
		if (!StringUtils.isBlank(resignationVO.getRequestUserName())) {
			whereSql.append(" and staff.StaffName like '%"+resignationVO.getRequestUserName()+"%' ");
		}
		if (!StringUtils.isBlank(resignationVO.getBeginDate())) {
			whereSql.append(" and staff.leaveDate >= '"+resignationVO.getBeginDate()+"'");
		}
		if (!StringUtils.isBlank(resignationVO.getEndDate())) {
			whereSql.append(" and staff.leaveDate <= '"+resignationVO.getEndDate()+"'");
		}
		if (resignationVO.getCompanyID() != null) {
			whereSql.append(" and groupDetail.companyID = "+resignationVO.getCompanyID());
			if (resignationVO.getDepartmentID() != null) {
				List<DepartmentVO> departmentVOs = positionService.findDepartmentsByCompanyIDParentID(resignationVO.getCompanyID(), resignationVO.getDepartmentID());
				List<Integer> departmentIDs = Lists2.transform(departmentVOs, new SafeFunction<DepartmentVO, Integer>() {
					@Override
					protected Integer safeApply(DepartmentVO input) {
						return input.getDepartmentID();
					}
				});
				departmentIDs.add(resignationVO.getDepartmentID());
				String arrayString = Arrays.toString(departmentIDs.toArray());
				whereSql.append(" and groupDetail.departmentID in ("+arrayString.substring(1, arrayString.length()-1)+")");
			}
		}
	
		return whereSql.toString();
		
	}
}
